<div class="attention-container">
  <app-header></app-header>
  <main>
    <h2>Atender Citas del Día</h2>
    
    <div class="filter-section">
      <form [formGroup]="filterForm" (ngSubmit)="filtrarCitas()">
        <mat-form-field appearance="fill">
          <mat-label>Fecha</mat-label>
          <input matInput formControlName="fecha" type="date" (change)="filtrarCitas()">
        </mat-form-field>
        
        <mat-form-field appearance="fill">
          <mat-label>Filtrar por ID de Mascota (opcional)</mat-label>
          <input matInput formControlName="idMascota" placeholder="Deje vacío para ver todas" (change)="filtrarCitas()">
        </mat-form-field>
      </form>
    </div>

    <div class="citas-cards" *ngIf="!mostrarFormulario">
      <h3>Citas Programadas</h3>
      <div class="cards-container">
        <mat-card *ngFor="let cita of citasFiltradas" class="cita-card">
          <mat-card-header>
            <mat-card-title>Cita #{{ cita.idCita }}</mat-card-title>
          </mat-card-header>
          <mat-card-content>
            <p><strong>Mascota:</strong> {{ getMascotaNombre(cita.idMascota) }} (ID: {{ cita.idMascota }})</p>
            <p><strong>Fecha:</strong> {{ cita.fechaCita }}</p>
            <p><strong>Hora:</strong> {{ cita.horaCita }}</p>
            <p><strong>Motivo:</strong> {{ cita.motivo }}</p>
            <p><strong>Veterinario:</strong> {{ cita.veterinarioAsignado }}</p>
            <p><strong>Estado:</strong> {{ cita.estadoCita }}</p>
            <p *ngIf="cita.observaciones"><strong>Observaciones:</strong> {{ cita.observaciones }}</p>
          </mat-card-content>
          <mat-card-actions>
            <button mat-raised-button color="primary" (click)="seleccionarCita(cita)">Atender</button>
          </mat-card-actions>
        </mat-card>
        <p *ngIf="citasFiltradas.length === 0" class="no-citas">
          No hay citas programadas para esta fecha.
        </p>
      </div>
    </div>

    <div class="attention-form" *ngIf="mostrarFormulario && citaSeleccionada">
      <h3>Registrar Atención - Cita #{{ citaSeleccionada.idCita }}</h3>
      <form [formGroup]="attentionForm" (ngSubmit)="onSubmit()">
        <mat-form-field appearance="fill">
          <mat-label>ID Atención</mat-label>
          <input matInput formControlName="idAtencion" [class.is-invalid]="isFieldInvalid('idAtencion')">
          <mat-error *ngIf="isFieldInvalid('idAtencion')">
            {{ getErrorMessage('idAtencion') }}
          </mat-error>
          <mat-hint>Ingrese un ID único para la atención</mat-hint>
        </mat-form-field>

        <mat-form-field appearance="fill">
          <mat-label>ID Cita</mat-label>
          <input matInput formControlName="idCita" readonly>
          <mat-hint>ID de la cita atendida</mat-hint>
        </mat-form-field>

        <mat-form-field appearance="fill">
          <mat-label>Fecha de Atención Real</mat-label>
          <input matInput formControlName="fechaAtencionReal" type="date" [class.is-invalid]="isFieldInvalid('fechaAtencionReal')">
          <mat-error *ngIf="isFieldInvalid('fechaAtencionReal')">
            {{ getErrorMessage('fechaAtencionReal') }}
          </mat-error>
        </mat-form-field>

        <mat-form-field appearance="fill">
          <mat-label>Veterinario</mat-label>
          <mat-select formControlName="veterinario" [class.is-invalid]="isFieldInvalid('veterinario')">
            <mat-option value="Dr. Lujan">Dr. Lujan</mat-option>
            <mat-option value="Dr. Quispe">Dr. Quispe</mat-option>
          </mat-select>
          <mat-error *ngIf="isFieldInvalid('veterinario')">
            {{ getErrorMessage('veterinario') }}
          </mat-error>
        </mat-form-field>

        <mat-form-field appearance="fill">
          <mat-label>Diagnóstico</mat-label>
          <textarea matInput formControlName="diagnostico" rows="3" [class.is-invalid]="isFieldInvalid('diagnostico')"></textarea>
          <mat-error *ngIf="isFieldInvalid('diagnostico')">
            {{ getErrorMessage('diagnostico') }}
          </mat-error>
          <mat-hint>Describa el diagnóstico (mínimo 5 caracteres)</mat-hint>
        </mat-form-field>

        <mat-form-field appearance="fill">
          <mat-label>Procedimiento</mat-label>
          <textarea matInput formControlName="procedimiento" rows="3" [class.is-invalid]="isFieldInvalid('procedimiento')"></textarea>
          <mat-error *ngIf="isFieldInvalid('procedimiento')">
            {{ getErrorMessage('procedimiento') }}
          </mat-error>
          <mat-hint>Describa el procedimiento realizado (mínimo 5 caracteres)</mat-hint>
        </mat-form-field>

        <mat-form-field appearance="fill">
          <mat-label>Receta</mat-label>
          <textarea matInput formControlName="receta" rows="3" [class.is-invalid]="isFieldInvalid('receta')"></textarea>
          <mat-error *ngIf="isFieldInvalid('receta')">
            {{ getErrorMessage('receta') }}
          </mat-error>
          <mat-hint>Indique la receta prescrita (mínimo 3 caracteres)</mat-hint>
        </mat-form-field>

        <mat-form-field appearance="fill">
          <mat-label>Tratamiento</mat-label>
          <textarea matInput formControlName="tratamiento" rows="2" [class.is-invalid]="isFieldInvalid('tratamiento')"></textarea>
          <mat-error *ngIf="isFieldInvalid('tratamiento')">
            {{ getErrorMessage('tratamiento') }}
          </mat-error>
          <mat-hint>Opcional: describa el tratamiento</mat-hint>
        </mat-form-field>

        <mat-form-field appearance="fill">
          <mat-label>Vacunas Aplicadas</mat-label>
          <textarea matInput formControlName="vacunasAplicadas" rows="2" [class.is-invalid]="isFieldInvalid('vacunasAplicadas')"></textarea>
          <mat-error *ngIf="isFieldInvalid('vacunasAplicadas')">
            {{ getErrorMessage('vacunasAplicadas') }}
          </mat-error>
          <mat-hint>Opcional: indique las vacunas aplicadas</mat-hint>
        </mat-form-field>

        <mat-form-field appearance="fill">
          <mat-label>Peso Actual (kg)</mat-label>
          <input matInput formControlName="pesoActual" type="number" step="0.1" [class.is-invalid]="isFieldInvalid('pesoActual')">
          <mat-error *ngIf="isFieldInvalid('pesoActual')">
            {{ getErrorMessage('pesoActual') }}
          </mat-error>
          <mat-hint>Opcional: peso actual de la mascota</mat-hint>
        </mat-form-field>

        <mat-form-field appearance="fill">
          <mat-label>Estado Final</mat-label>
          <mat-select formControlName="estadoFinal" [class.is-invalid]="isFieldInvalid('estadoFinal')">
            <mat-option value="Completado">Completado</mat-option>
            <mat-option value="Pendiente">Pendiente</mat-option>
          </mat-select>
          <mat-error *ngIf="isFieldInvalid('estadoFinal')">
            {{ getErrorMessage('estadoFinal') }}
          </mat-error>
        </mat-form-field>

        <mat-form-field appearance="fill">
          <mat-label>Próximo Control</mat-label>
          <input matInput formControlName="proximoControl" type="date" [class.is-invalid]="isFieldInvalid('proximoControl')">
          <mat-error *ngIf="isFieldInvalid('proximoControl')">
            {{ getErrorMessage('proximoControl') }}
          </mat-error>
          <mat-hint>Opcional: fecha del próximo control</mat-hint>
        </mat-form-field>

        <mat-form-field appearance="fill">
          <mat-label>Observaciones</mat-label>
          <textarea matInput formControlName="observaciones" rows="2" [class.is-invalid]="isFieldInvalid('observaciones')"></textarea>
          <mat-error *ngIf="isFieldInvalid('observaciones')">
            {{ getErrorMessage('observaciones') }}
          </mat-error>
          <mat-hint>Opcional: observaciones adicionales</mat-hint>
        </mat-form-field>

        <div class="form-actions">
          <button mat-raised-button color="primary" type="submit" [disabled]="attentionForm.invalid && submitted">
            Registrar Atención
          </button>
          <button mat-raised-button type="button" (click)="cancelarAtencion()">Cancelar</button>
        </div>
      </form>
    </div>
  </main>
  <app-footer></app-footer>
</div>

